<div class="konva-container" [class.light-theme]="!isDarkTheme()">
  <div class="main-content">
    <!-- Left Sidebar -->
    <div class="sidebar" [class.closed]="!sidebarOpen()">
      <!-- Toggle button on right border - Lighter design -->
      <button class="sidebar-toggle-btn" (click)="toggleSidebar()" [title]="sidebarOpen() ? 'Hide Sidebar' : 'Show Sidebar'">
        <span class="toggle-icon">{{ sidebarOpen() ? '‚Äπ' : '‚Ä∫' }}</span>
      </button>
      
      <!-- Search Input at Top -->
      <div class="sidebar-search">
        <input 
          type="text" 
          class="search-input"
          placeholder="üîç Search components..."
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
        />
      </div>
      
      <!-- Add Custom Component Button -->
      <button class="add-custom-btn" (click)="openCustomComponentModal()" title="Add Custom Component">
        <span class="btn-icon">‚≠ê</span>
        <span class="btn-text">Add Custom Component</span>
      </button>

      <!-- Categories Container (Full Height Scrollable) -->
      <div class="categories-container">
        <div 
          *ngFor="let category of getFilteredCategories()"
          class="category"
        >
          <div 
            class="category-header"
            (click)="toggleCategory(category)"
          >
            <span class="category-icon">
              <i [class]="category.icon"></i>
            </span>
            <span class="category-name">{{ category.name }}</span>
            <span class="category-toggle-icon">{{ category.collapsed ? '‚Ä∫' : '‚Äπ' }}</span>
          </div>

          <div class="category-items" *ngIf="!category.collapsed">
            <div 
              *ngFor="let component of category.components"
              class="service-item"
              draggable="true"
              (dragstart)="onDragStart($event, component)"
              [style.border-left-color]="component.color"
            >
              <div class="service-icon" [style.color]="component.color">
                <!-- Show custom uploaded image if available -->
                <img *ngIf="hasCustomImage(component)" [src]="getCustomImageUrl(component)" alt="Custom icon" class="custom-icon-img" />
                <!-- Show Font Awesome icon if available and no custom image -->
                <i *ngIf="!hasCustomImage(component) && component.faIcon" [class]="component.faIcon"></i>
                <!-- Show emoji as fallback -->
                <span *ngIf="!hasCustomImage(component) && !component.faIcon">{{ component.icon }}</span>
              </div>
              <div class="service-content">
                <div class="service-header">
                  <div class="service-name">{{ component.name }}</div>
                  <div *ngIf="component.provider" class="service-provider">{{ component.provider }}</div>
                </div>
                <div class="service-description">{{ component.description }}</div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="getFilteredCategories().length === 0" class="empty-state">
          <p>No components found</p>
        </div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-wrapper">
      <div 
        #canvasContainer
        (drop)="onCanvasDrop($event)"
        (dragover)="$event.preventDefault()"
        style="width: 100%; height: 100%;"
      >
      </div>
      
      <!-- Compact TLDraw-Style Right Panel (Draggable Card) -->
      <div class="compact-style-panel draggable-panel" #stylePanel>
        <div class="panel-drag-handle">‚ãÆ‚ãÆ</div>
      
      <!-- Color Mode Toggle (Stroke/Fill) -->
      <div class="color-mode-toggle">
        <button 
          class="mode-btn"
          [class.active]="colorMode() === 'stroke'"
          (click)="setColorMode('stroke')"
          title="Border/Stroke Color"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
          </svg>
        </button>
        <button 
          class="mode-btn"
          [class.active]="colorMode() === 'fill'"
          (click)="setColorMode('fill')"
          title="Fill Color"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
          </svg>
        </button>
      </div>
      
      <!-- Colors - 4x3 Grid -->
      <div class="colors-grid">
        <button
          *ngFor="let color of compactColors"
          class="color-circle"
          [class.active]="getCurrentModeColor() === color"
          [style.background-color]="color"
          (click)="setCurrentModeColor(color)"
          [title]="color"
        ></button>
      </div>
      
      <!-- Color Opacity Slider (Low to High Intensity) -->
      <div class="slider-section opacity-slider">
        <div class="slider-track-gradient" [style.background]="'linear-gradient(to right, transparent, ' + currentColor() + ')'"></div>
        <input 
          type="range" 
          min="0" 
          max="100" 
          [value]="colorOpacity()"
          (input)="setColorOpacity(+$any($event.target).value)"
          class="compact-slider opacity-range"
          title="Color intensity: {{ colorOpacity() }}%"
        />
      </div>
      
      <!-- Stroke Width Slider -->
      <div class="slider-section">
        <input 
          type="range" 
          min="1" 
          max="20" 
          [value]="strokeWidth()"
          (input)="setStrokeWidth(+$any($event.target).value)"
          class="compact-slider"
        />
      </div>
      
      <!-- Fill Patterns - 4 Squares -->
      <div class="fill-patterns">
        <button 
          class="pattern-btn"
          [class.active]="fillStyle() === 'solid'"
          (click)="setFillStyle('solid')"
          title="Solid fill"
        >
          <div class="pattern-square solid"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="fillStyle() === 'hatch'"
          (click)="setFillStyle('hatch')"
          title="Overlapping"
        >
          <div class="pattern-square overlapping"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="fillStyle() === 'cross-hatch'"
          (click)="setFillStyle('cross-hatch')"
          title="Double square"
        >
          <div class="pattern-square double"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="fillStyle() === 'dotted'"
          (click)="setFillStyle('dotted')"
          title="Pattern"
        >
          <div class="pattern-square pattern"></div>
        </button>
      </div>
      
      <!-- Stroke Patterns - 4 Circles -->
      <div class="stroke-patterns">
        <button 
          class="pattern-btn"
          [class.active]="strokePattern === 'solid'"
          (click)="setStrokePattern('solid')"
          title="Solid stroke"
        >
          <div class="pattern-circle solid"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="strokePattern === 'dashed'"
          (click)="setStrokePattern('dashed')"
          title="Dashed"
        >
          <div class="pattern-circle dashed"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="strokePattern === 'dotted'"
          (click)="setStrokePattern('dotted')"
          title="Dotted"
        >
          <div class="pattern-circle dotted"></div>
        </button>
        <button 
          class="pattern-btn"
          [class.active]="strokePattern === 'none'"
          (click)="setStrokePattern('none')"
          title="No stroke"
        >
          <div class="pattern-circle none"></div>
        </button>
      </div>
      
      <!-- Size Presets -->
      <div class="size-presets">
        <button 
          class="size-circle"
          [class.active]="sizePreset() === 'small'"
          (click)="setSizePreset('small')"
          title="Small"
        >S</button>
        <button 
          class="size-circle"
          [class.active]="sizePreset() === 'medium'"
          (click)="setSizePreset('medium')"
          title="Medium"
        >M</button>
        <button 
          class="size-circle"
          [class.active]="sizePreset() === 'large'"
          (click)="setSizePreset('large')"
          title="Large"
        >L</button>
        <button 
          class="size-circle"
          [class.active]="sizePreset() === 'xlarge'"
          (click)="setSizePreset('xlarge')"
          title="Extra Large"
        >XL</button>
      </div>
      
      <!-- Font Size - 4 Aa Buttons -->
      <div class="font-size-options">
        <button 
          class="font-btn"
          [class.active]="fontSize() === 12"
          (click)="setFontSize(12)"
          title="Small Text"
        >
          <span style="font-size: 10px; font-weight: 500;">Aa</span>
        </button>
        <button 
          class="font-btn"
          [class.active]="fontSize() === 16"
          (click)="setFontSize(16)"
          title="Medium Text"
        >
          <span style="font-size: 13px; font-weight: 500;">Aa</span>
        </button>
        <button 
          class="font-btn"
          [class.active]="fontSize() === 24"
          (click)="setFontSize(24)"
          title="Large Text"
        >
          <span style="font-size: 16px; font-weight: 500;">Aa</span>
        </button>
        <button 
          class="font-btn"
          [class.active]="fontSize() === 32"
          (click)="setFontSize(32)"
          title="Extra Large Text"
        >
          <span style="font-size: 19px; font-weight: 600;">Aa</span>
        </button>
      </div>
      
      <!-- Text Alignment - 4 Buttons -->
      <div class="text-align-options">
        <button 
          class="align-btn"
          [class.active]="textAlign() === 'left'"
          (click)="setTextAlign('left')"
          title="Align Left"
        >
          <svg width="16" height="16" viewBox="0 0 16 16">
            <line x1="2" y1="3" x2="14" y2="3" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="6" x2="10" y2="6" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="9" x2="12" y2="9" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="12" x2="8" y2="12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
        <button 
          class="align-btn"
          [class.active]="textAlign() === 'center'"
          (click)="setTextAlign('center')"
          title="Align Center"
        >
          <svg width="16" height="16" viewBox="0 0 16 16">
            <line x1="2" y1="3" x2="14" y2="3" stroke="currentColor" stroke-width="1.5"/>
            <line x1="4" y1="6" x2="12" y2="6" stroke="currentColor" stroke-width="1.5"/>
            <line x1="3" y1="9" x2="13" y2="9" stroke="currentColor" stroke-width="1.5"/>
            <line x1="5" y1="12" x2="11" y2="12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
        <button 
          class="align-btn"
          [class.active]="textAlign() === 'right'"
          (click)="setTextAlign('right')"
          title="Align Right"
        >
          <svg width="16" height="16" viewBox="0 0 16 16">
            <line x1="2" y1="3" x2="14" y2="3" stroke="currentColor" stroke-width="1.5"/>
            <line x1="6" y1="6" x2="14" y2="6" stroke="currentColor" stroke-width="1.5"/>
            <line x1="4" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1.5"/>
            <line x1="8" y1="12" x2="14" y2="12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
        <button 
          class="align-btn"
          [class.active]="textAlign() === 'justify'"
          (click)="setTextAlign('justify')"
          title="Justify"
        >
          <svg width="16" height="16" viewBox="0 0 16 16">
            <line x1="2" y1="3" x2="14" y2="3" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="6" x2="14" y2="6" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="12" x2="14" y2="12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Right Horizontal Toolbar at Top (Draggable) -->
    <div class="right-top-toolbar draggable-panel" #toolbar>
      <div class="panel-drag-handle">‚ãÆ‚ãÆ</div>
      <!-- Drawing Tools -->
      <button class="h-tool-btn" [class.active]="currentTool() === 'select'" (click)="setTool('select')" data-tooltip="Select Tool (V) - Select and move shapes">‚ÜñÔ∏è</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'hand'" (click)="setTool('hand')" data-tooltip="Hand Tool (H) - Pan canvas">‚úã</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'connector'" (click)="setTool('connector')" data-tooltip="Connector Tool (K) - Draw connections between shapes">üîó</button>
      <button class="h-tool-btn" [class.active]="useCurvedConnectors()" (click)="toggleCurvedConnectors()" data-tooltip="Toggle Curved/Straight Connectors - Switch between bezier curves and straight lines">„Ä∞Ô∏è</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'pen'" (click)="setTool('pen')" data-tooltip="Pen Tool (P) - Freehand drawing">‚úèÔ∏è</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'rectangle'" (click)="setTool('rectangle')" data-tooltip="Rectangle Tool (R) - Draw rectangles">‚ñ≠</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'circle'" (click)="setTool('circle')" data-tooltip="Circle Tool (C) - Draw circles">‚óã</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'arrow'" (click)="setTool('arrow')" data-tooltip="Arrow Tool (A) - Draw directional arrows">‚Üí</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'line'" (click)="setTool('line')" data-tooltip="Line Tool (L) - Draw straight lines">‚îÄ</button>
      <button class="h-tool-btn" [class.active]="currentTool() === 'text'" (click)="setTool('text')" data-tooltip="Text Tool (T) - Add text labels">T</button>
      <button class="h-tool-btn" #shapePickerBtn [class.active]="currentTool() === 'shape'" (click)="toggleShapePicker($event)" data-tooltip="More Shapes - Triangle, Diamond, Pentagon, Hexagon, Star">‚óá</button>
      <button class="h-tool-btn" (click)="triggerImageUpload()" data-tooltip="Upload Image - Add images to canvas">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
      </button>
      
      <div class="h-divider"></div>
      
      <!-- Actions -->
      <button class="h-tool-btn" (click)="generateAILayout()" data-tooltip="AI Layout Generator - Automatically arrange architecture">‚ú®</button>
      <button class="h-tool-btn" (click)="lockSelected()" data-tooltip="Lock Selected - Prevent editing">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="5" y="11" width="14" height="10" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="unlockSelected()" data-tooltip="Unlock Selected - Allow editing">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="5" y="11" width="14" height="10" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="createGroup()" data-tooltip="Group Selected (‚åòG / Ctrl+G) - Combine shapes into a group">üì¶</button>
      <button class="h-tool-btn" (click)="clearCanvas()" data-tooltip="Clear Canvas - Delete all shapes">üóëÔ∏è</button>
      
      <div class="h-divider"></div>
      
      <!-- Zoom Controls -->
      <button class="h-tool-btn zoom-btn" (click)="zoomIn()" data-tooltip="Zoom In (+) - Increase zoom level">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
          <line x1="11" y1="8" x2="11" y2="14"/>
          <line x1="8" y1="11" x2="14" y2="11"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="resetZoom()" data-tooltip="Reset Zoom (0) - Return to 100%">100%</button>
      <button class="h-tool-btn zoom-btn" (click)="zoomOut()" data-tooltip="Zoom Out (-) - Decrease zoom level">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
          <line x1="8" y1="11" x2="14" y2="11"/>
        </svg>
      </button>
      <button class="h-tool-btn zoom-btn" (click)="zoomToFit()" data-tooltip="Zoom to Fit - Fit all shapes in view">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
      
      <div class="h-divider"></div>
      
      <!-- Grid Toggle -->
      <button class="h-tool-btn" (click)="toggleGrid()" [attr.data-tooltip]="showGrid() ? 'Hide Grid - Remove background grid' : 'Show Grid - Display background grid'">
        {{ showGrid() ? '‚ñ¶' : '‚ñ¢' }}
      </button>
      
      <!-- Theme Toggle -->
      <button class="h-tool-btn" (click)="toggleTheme()" [attr.data-tooltip]="isDarkTheme() ? 'Switch to Light Theme' : 'Switch to Dark Theme'">
        {{ isDarkTheme() ? '‚òÄÔ∏è' : 'üåô' }}
      </button>
      
      <div class="h-divider"></div>
      
      <!-- Export/Import -->
      <button class="h-tool-btn" (click)="exportToPNG()" data-tooltip="Export as PNG - Download canvas as image">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="exportToSVG()" data-tooltip="Export as SVG - Download scalable vector graphic">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="exportToJSON()" data-tooltip="Save as JSON - Export diagram data for backup">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
      </button>
      <button class="h-tool-btn" (click)="importFromJSON()" data-tooltip="Load from JSON - Import saved diagram">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="12" y1="18" x2="12" y2="12"/>
          <polyline points="9 15 12 18 15 15"/>
        </svg>
      </button>
      
      <div class="h-divider"></div>
      
      <!-- NEW FEATURES -->
      <button class="h-tool-btn" (click)="createNewTemplate()" data-tooltip="New Canvas - Create blank canvas">üìÑ</button>
      <button class="h-tool-btn" (click)="zoomToFit()" data-tooltip="Zoom to Fit (Fit all shapes in view)">üìê</button>
      <button class="h-tool-btn" (click)="autoLayout()" data-tooltip="Auto Layout - Arrange all shapes in organized grid">üéØ</button>
      <button class="h-tool-btn" [class.active]="showTemplatesPanel()" (click)="toggleTemplatesPanel()" data-tooltip="Templates Gallery (üìã) - Load pre-built architecture diagrams">üìã</button>
      <button class="h-tool-btn" (click)="saveAsTemplate()" data-tooltip="Save as Template (üíæ) - Export current canvas as reusable template">üíæ</button>
      <button class="h-tool-btn" (click)="toggleShortcutsPanel()" data-tooltip="Keyboard Shortcuts (‚å®Ô∏è) - View all keyboard shortcuts (Press ?)">‚å®Ô∏è</button>
      <button class="h-tool-btn" (click)="clearAutoSaveData()" data-tooltip="Clear Auto-Save (üóëÔ∏è) - Reset auto-save data and start fresh" style="color: #ef4444;">üîÑ</button>
    </div>
    
    <!-- Hidden file input for image upload -->
    <input 
      type="file" 
      #imageUpload 
      accept="image/*" 
      (change)="onImageUpload($event)" 
      style="display: none;"
    />
    
    <!-- Shape Picker Popup (Inline, not modal) -->
    <div class="shape-picker-backdrop" *ngIf="showShapePicker()" (click)="toggleShapePicker()"></div>
    <div class="shape-picker-popup" *ngIf="showShapePicker()" 
         [style.top]="shapePickerPosition.top" 
         [style.right]="shapePickerPosition.right">
      <div class="shape-picker-grid-compact">
        <button
          *ngFor="let shape of shapeTemplates"
          class="shape-btn-compact"
          [class.active]="selectedShape() === shape.id"
          (click)="selectShapeTemplate(shape.id)"
          [title]="shape.name"
        >
          <span class="shape-icon-compact">{{ shape.icon }}</span>
        </button>
      </div>
    </div>
    
  </div>
</div>

<!-- Custom Component Creator Modal -->
<div *ngIf="showCustomComponentModal()" class="modal-overlay" (click)="closeCustomComponentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Create Custom Component</h2>
      <button class="modal-close-btn" (click)="closeCustomComponentModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <!-- Component Name -->
      <div class="form-group">
        <label for="component-name">Component Name *</label>
        <input 
          type="text" 
          id="component-name"
          class="form-control"
          placeholder="e.g., My Custom Service"
          [ngModel]="customComponentName()"
          (ngModelChange)="customComponentName.set($event)"
        />
      </div>
      
      <!-- Component Description -->
      <div class="form-group">
        <label for="component-description">Description</label>
        <textarea 
          id="component-description"
          class="form-control"
          placeholder="Brief description of the component"
          rows="3"
          [ngModel]="customComponentDescription()"
          (ngModelChange)="customComponentDescription.set($event)"
        ></textarea>
      </div>
      
      <!-- Color and Icon Row -->
      <div class="form-row">
        <!-- Color Picker -->
        <div class="form-group" style="flex: 1;">
          <label for="component-color">Color</label>
          <input 
            type="color" 
            id="component-color"
            class="form-control color-picker"
            [ngModel]="customComponentColor()"
            (ngModelChange)="customComponentColor.set($event)"
          />
        </div>
        
        <!-- Icon/Emoji -->
        <div class="form-group" style="flex: 1;">
          <label for="component-icon">Icon/Emoji</label>
          <input 
            type="text" 
            id="component-icon"
            class="form-control"
            placeholder="üì¶"
            maxlength="4"
            [ngModel]="customComponentIcon()"
            (ngModelChange)="customComponentIcon.set($event)"
          />
        </div>
      </div>
      
      <!-- Image Upload -->
      <div class="form-group">
        <label for="component-image">Upload Icon/Image (Optional)</label>
        <input 
          type="file" 
          id="component-image"
          class="form-control file-input"
          accept="image/*"
          (change)="onCustomComponentImageUpload($event)"
        />
        <small class="form-hint">SVG, PNG, or JPG. Will replace emoji/icon if uploaded.</small>
      </div>
      
      <!-- Image Preview -->
      <div *ngIf="customComponentImageUrl()" class="image-preview">
        <label>Preview:</label>
        <img [src]="customComponentImageUrl()" alt="Component preview" />
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCustomComponentModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitCustomComponent()">Add Component</button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Help Panel -->
<div *ngIf="showShortcutsPanel()" class="shortcuts-overlay" (click)="toggleShortcutsPanel()">
  <div class="shortcuts-panel" (click)="$event.stopPropagation()">
    <div class="shortcuts-header">
      <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
      <button class="close-btn" (click)="toggleShortcutsPanel()">‚úï</button>
    </div>
    
    <div class="shortcuts-content">
      <div class="shortcuts-section">
        <h4>Tools & Actions</h4>
        <div class="shortcut-row">
          <span class="shortcut-key">V</span>
          <span class="shortcut-desc">Select Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">Esc</span>
          <span class="shortcut-desc">Return to Select Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">R</span>
          <span class="shortcut-desc">Rectangle Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">C</span>
          <span class="shortcut-desc">Circle Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">A</span>
          <span class="shortcut-desc">Arrow Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">L</span>
          <span class="shortcut-desc">Line Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">T</span>
          <span class="shortcut-desc">Text Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">K</span>
          <span class="shortcut-desc">Smart Connector Tool</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">G</span>
          <span class="shortcut-desc">Group Selected</span>
        </div>
      </div>

      <div class="shortcuts-section">
        <h4>Edit Operations</h4>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + C</span>
          <span class="shortcut-desc">Copy Selected</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + V</span>
          <span class="shortcut-desc">Paste</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + D</span>
          <span class="shortcut-desc">Duplicate Selected</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + Z</span>
          <span class="shortcut-desc">Undo</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + Shift + Z</span>
          <span class="shortcut-desc">Redo</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">Delete / Backspace</span>
          <span class="shortcut-desc">Delete Selected</span>
        </div>
      </div>

      <div class="shortcuts-section">
        <h4>Canvas Controls</h4>
        <div class="shortcut-row">
          <span class="shortcut-key">Space + Drag</span>
          <span class="shortcut-desc">Pan Canvas</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">‚åò/Ctrl + Scroll</span>
          <span class="shortcut-desc">Zoom In/Out</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">Shift + Drag</span>
          <span class="shortcut-desc">Multi-Select</span>
        </div>
        <div class="shortcut-row">
          <span class="shortcut-key">Double Click</span>
          <span class="shortcut-desc">Edit Text/Label</span>
        </div>
      </div>

      <div class="shortcuts-section">
        <h4>Help</h4>
        <div class="shortcut-row">
          <span class="shortcut-key">?</span>
          <span class="shortcut-desc">Show/Hide This Panel</span>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Templates Gallery Panel -->
<div *ngIf="showTemplatesPanel()" class="templates-overlay" (click)="toggleTemplatesPanel()">
  <div class="templates-panel" (click)="$event.stopPropagation()">
    <div class="templates-header">
      <h3>üìã Templates Gallery</h3>
      <button class="close-btn" (click)="toggleTemplatesPanel()">‚úï</button>
    </div>
    
    <!-- Tab Buttons -->
    <div class="templates-tabs">
      <button 
        class="tab-btn" 
        [class.active]="!showMyTemplates()"
        (click)="showMyTemplates.set(false)"
      >
        üåê Pre-built Templates
      </button>
      <button 
        class="tab-btn" 
        [class.active]="showMyTemplates()"
        (click)="showMyTemplates.set(true)"
      >
        üíæ My Templates ({{ myTemplates.length }})
      </button>
    </div>
    
    <!-- Save Current Button -->
    <div class="template-actions" *ngIf="showMyTemplates()">
      <button class="save-template-btn" (click)="saveAsMyTemplate()">
        ‚ûï Save Current Canvas as Template
      </button>
    </div>
    
    <div class="templates-search" *ngIf="!showMyTemplates()">
      <input 
        type="text" 
        [(ngModel)]="templateSearchQuery"
        placeholder="üîç Search templates..."
        class="search-input"
      />
    </div>
    
    <div class="templates-content">
      <!-- Pre-built Templates List -->
      <div class="templates-list" *ngIf="!showMyTemplates()">
        <div *ngFor="let template of getFilteredTemplates()" 
             class="template-item"
             (click)="loadTemplate(template.file)">
          <div class="template-icon">{{ template.thumbnail }}</div>
          <div class="template-details">
            <h4>{{ template.name }}</h4>
            <p>{{ template.description }}</p>
          </div>
          <span class="template-badge">{{ template.category }}</span>
        </div>
        
        <div *ngIf="getFilteredTemplates().length === 0" class="no-results">
          <p>No templates found</p>
          <p class="hint">Try a different search term</p>
        </div>
      </div>
      
      <!-- My Templates List -->
      <div class="templates-list" *ngIf="showMyTemplates()">
        <div *ngFor="let template of myTemplates" 
             class="template-item my-template-item"
             (click)="loadMyTemplate(template)">
          <div class="template-icon">{{ template.thumbnail }}</div>
          <div class="template-details">
            <h4>{{ template.name }}</h4>
            <p>{{ template.description }}</p>
          </div>
          <button class="delete-template-btn" (click)="deleteMyTemplate(template, $event)" title="Delete Template">
            üóëÔ∏è
          </button>
        </div>
        
        <div *ngIf="myTemplates.length === 0" class="no-results">
          <p>No custom templates yet</p>
          <p class="hint">Click "Save Current Canvas as Template" to create your first template</p>
        </div>
      </div>
    </div>
    
    <div class="templates-footer">
      <p class="templates-hint">üí° Your work is auto-saved and will restore on refresh</p>
    </div>
  </div>
</div>

